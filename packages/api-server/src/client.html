<h1> Argon Client </h1>

<input type="text" id="name" placeholder="name" value="alvin"> <br>
<input type="text" id="email" placeholder="email"> <br>
<input type="text" id="username" placeholder="username" value="alvin"> <br>
<input type="text" id="password" placeholder="password" value="87654321"> <br>
<button id="login">login</button>
<button id="signup">signup</button>

<p>UserID: <b id='userId'>NA</b> </p>
<p>SessionID: <b id='sessionId'>NA</b> </p>


<h2>Contests</h2>
<button id='contest-get'>get</button> <br>
<div id='contest-list'> </div>

<h2>Teams</h2>
<input id='team-name' type='text'> <br>
<button id='team-make'>make</button> <br>
<button id='team-get'>get</button> <br>
<div id='team-list'></div>

<h2>Problems</h2>
<button id='problem-get'>get</button> <br>
<div id='problem-list'> </div>

<h2>Submissions</h2>
<label for="lang">Language:</label>
<select name="lang" id="submission-lang" value="C++17">
   <option value="C">C</option>
   <option value="C++">C++</option>
   <option value="Python">Python</option>
</select> <br>
<input type="file" id="submission-file"> <br>
<button id='submission-submit'>submit</button> <br>
<button id='submission-get'>get</button> <br>
<div id='submission-list'></div>

<h2>Ranklist</h2>
<button id='ranklist-get'>get</button> <br>
<div id='ranklist-list'></div>



<script>
  let getUserId = _ => undefined;

  const getProblemId = _ => document.querySelector('input[name="problem-radio"]:checked').value;
  const getSeriesId = _ => document.querySelector('input[name="series-radio"]:checked').value;
  const getContestId = _ => document.querySelector('input[name="contest-radio"]:checked').value;


  document.getElementById('signup').onclick = _ => {

    console.log('signup');

    const body = {
      name: document.getElementById('name').value,
      username: document.getElementById('username').value,
      password: document.getElementById('password').value,
      email:document.getElementById('email').value,
      year:"2025",
      school:"Rock High School",
      country:"USA",
      region:"Pacific"
    };

    if (!body.name) return alert('no name');
    if (!body.email) return alert('no email');
    if (!body.username) return alert('no username');
    if (!body.password) return alert('no password');

    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body)
    };

    fetch('/v1/users/', options) 
      .then(response => response.json())
      .then(response => console.log(response))
      .catch(err => console.error(err));
  }

  document.getElementById('login').onclick = _ => {

    console.log('login');

    const body = {
      usernameOrEmail: document.getElementById('username').value,
      password: document.getElementById('password').value,
    };

    if (!body.usernameOrEmail) return alert('no username or email');
    if (!body.password) return alert('no password');

    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body)
    };

    fetch('/v1/sessions/', options)
      .then(response => {console.log(response.headers); return response.json()})
      .then(response => {
        console.log(response)
        document.getElementById('userId').innerText = response.userId;
        document.getElementById('sessionId').innerText = response.sessionId;
        getUserId = () => response.userId;
      })
      .catch(err => console.error(err));
  }

  document.getElementById('contest-get').onclick = async _ => {

    console.log('contest-get');

    const res = await fetch(`/v1/contest-series/`)
      .then(res => res.json())
      .catch(console.error);

    if (res.error)
      return console.error(res.message);

    let html = '';
    for (const { name: series, contests } of res) {
      for (const id of contests) {
        const { name, published } = await fetch (`/v1/contests/${id}`)
          .then(res => res.json())
          .catch(console.error);
        
        html += `
          <div>
          <input type='radio' name='contest-radio' value='${id}'>
          <label for='${id}'><b>${name}</b> from <i>${series}</i> (${published}): ${id}</label>
          </div>`
      }
    }
    document.getElementById('contest-list').innerHTML = html;
  }

  document.getElementById('team-make').onclick = async _ => {

    console.log('team-make');

    const body = { name: document.getElementById('team-name').value };

    if (!body.name) return alert('no team name');

    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body)
    };

    const { teamId } = await fetch(`/v1/contests/${getContestId()}/teams/`, options)
      .then(res => res.json())
      .catch(console.error);
  }

  document.getElementById('team-get').onclick = async _ => {

    console.log('team-get');

    const { teams } = await fetch(`/v1/users/${getUserId()}/profiles/private`)
      .then(res => res.json())
      .catch(console.error);

    console.log(teams);
    let html = '';
    for (const [contestId, teamId] of Object.entries(teams)) {
      html += `<div><b>${teamId}</b>: ${contestId}</div>`
    }

    document.getElementById('team-list').innerHTML = html;
  }

  document.getElementById('problem-get').onclick = async _ => {

    console.log('problems-get');

    const res = await fetch(`/v1/contests/${getContestId()}/problems/`)
      .then(res => res.json())
      .catch(console.error);

    if (res.error)
      return console.error(res.message);

    let html = '';
    for (const { name, id } of res.problems) {
      html += ` 
      <div>
      <input type='radio' name='problem-radio' value='${id}'>
      <label for='${id}'>${name}: ${id}</label>
      </div>`
    }

    document.getElementById('problem-list').innerHTML = html;
  }

  document.getElementById('submission-submit').onclick = async _ => {

    console.log('submission-submit');

    const file = document.getElementById('submission-file').files[0];
    if (!file) return alert('no file selected');

    const body = { 
      language: document.getElementById('submission-lang').value,
      source: await file.text()
    };

    if (!body.language) return alert('no language');
    if (!body.source) return alert('no source, error on reading file');

    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(body)
    };

    const { teamId } = await fetch(`/v1/contests/${getContestId()}/problems/${getProblemId()}/submissions`, options)
      .then(res => res.json())
      .catch(console.error);
  }

  document.getElementById('submission-get').onclick = async _ => {

    console.log('submission-get');

    const submissions = await fetch(`/v1/users/${getUserId()}/submissions`)
      .then(res => res.json())
      .catch(console.error);

    let html = '';
    for (const { problemId, createdAt, status, score } of submissions) {
      html += `
      <div>${problemId} @ ${createdAt}: <b>${status}</b> => ${score !== undefined ? score : '...'}</div>`
    }

    document.getElementById('submission-list').innerHTML = html;
  }

  document.getElementById('ranklist-get').onclick = async _ => {

    console.log('ranklist-get');

    const list = await fetch(`/v1/contests/${getContestId()}/ranklist`)
      .then(res => res.json())
      .catch(console.error);

    let html = '';
    for (const { id, totalScore: score } of list) {
      html += `
      <div>${id}: <b>${score}</b></div>`
    }

    document.getElementById('ranklist-list').innerHTML = html;
  }
</script>
